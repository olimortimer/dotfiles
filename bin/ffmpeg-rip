#!/usr/bin/env bash

#work out script dir
CWD=`pwd`;
DIR="$( cd -P "$( dirname "$0" )" && pwd )"
cd "$CWD"

SED_MODIFIER="-r"

if [[ "$OSTYPE" =~ ^darwin ]]; then
    SED_MODIFIER="-E"
fi

AUTOCROP="n"
MAX_WIDTH=""
MAX_HEIGHT=""
PROFILE=""
FF_CRF="19.5"
FF_PRESET="medium"

while [[ $# > 0 ]] ; do
    case "$1" in
        -crop)
            AUTOCROP="y"
        ;;
        -h)
            shift
            MAX_HEIGHT="$1"
        ;;
        -w)
            shift
            MAX_WIDTH="$1"
        ;;
        -crf)
            shift
            FF_CRF="$1"
        ;;
        -preset)
            shift
            FF_PRESET="$1"
        ;;
        *)
            break
        ;;
    esac
    shift
done

if [[ "$1" == '' ]]; then
    echo "No Source specified"
    exit 1
fi

if [[ "$2" == '' ]]; then
    echo "No Destination specified"
    exit 1
fi

if ffmpeg -i "$1" 2>&1 | grep 'Invalid data found' #check if it's video file
then
   echo "$1 is NOT A VALID FILE!"
   exit	   	
fi


SCALEDETECT="$DIR/ffmpeg-scaledetect"
if [ -n "$MAX_WIDTH" ]; then
    SCALEDETECT="$SCALEDETECT -mw $MAX_WIDTH"
fi
if [ -n "$MAX_HEIGHT" ]; then
    SCALEDETECT="$SCALEDETECT -mh $MAX_HEIGHT"
fi
FRAME=$(python $SCALEDETECT "$1")
VF_SCALE="scale=$FRAME"

# Check the padding. If we are cropping, just ignore the padding

VF_PADDING=""
VF_CROP=""

if [[ "$AUTOCROP" == "y" ]]; then
    CROPDETECT="$DIR/ffmpeg-cropdetect"
    if [ -n "$MAX_WIDTH" ]; then
        CROPDETECT="$SCALEDETECT -mw $MAX_WIDTH"
    fi
    if [ -n "$MAX_HEIGHT" ]; then
        CROPDETECT="$SCALEDETECT -mh $MAX_HEIGHT"
    fi
    CROPSTRING=$(python $CROPDETECT "$1")
    
    VF_CROP=",crop=$CROPSTRING"
else
    PADDINGDETECT="$DIR/ffmpeg-paddingdetect"
    if [ -n "$MAX_WIDTH" ]; then
        PADDINGDETECT="$PADDINGDETECT -w $MAX_WIDTH"
    fi
    if [ -n "$MAX_HEIGHT" ]; then
        PADDINGDETECT="$PADDINGDETECT -h $MAX_HEIGHT"
    fi
    PADDINGSTRING=$(bash $PADDINGDETECT "$1")
    
    
    VF_PADDING=",pad=$PADDINGSTRING"
fi

ffmpeg -threads 0 -y -i "$1" -map_chapters -1 -map_metadata -1 -sn -vf "${VF_SCALE}${VF_CROP}${VF_PADDING}" -c:v libx264 -crf "$FF_CRF" -preset "$FF_PRESET" -profile:v high -level:v 4.1 -c:a libfdk_aac -b:a 256k -ac 2 "$2" < /dev/null;
echo ""